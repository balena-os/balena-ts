ts4900 machine specific integration of resin environment configuration.

Upstream-Status: Inappropriate [configuration]

Signed-off-by: Florin Sarbu <florin@balena.io>
---
 include/configs/ts4900.h | 16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/include/configs/ts4900.h b/include/configs/ts4900.h
index 903bfc4..2f4ba72 100644
--- a/include/configs/ts4900.h
+++ b/include/configs/ts4900.h
@@ -172,6 +172,8 @@
 
 /* Miscellaneous commands */
 #define CONFIG_CMD_SETEXPR
+#define CONFIG_PARTITION_UUIDS
+#define CONFIG_CMD_PART
 
 /* allow to overwrite serial and ethaddr */
 #define CONFIG_ENV_OVERWRITE
@@ -225,7 +227,7 @@
 		"load mmc 0:1 ${loadaddr} /boot/ts4900-fpga.bin; " \
 		"ice40 ${loadaddr} ${filesize}; " \
 		"load mmc 0:1 ${loadaddr} ${uimage}; " \
-		"setenv bootargs root=/dev/mmcblk1p1 rootwait rw ${cmdline_append}; " \
+		"setenv bootargs ${resin_kernel_root} rootwait rw console=ttymxc0,115200 enable_wait_mode=off; " \
 		"bootm ${loadaddr} - ${fdtaddr}; \0" \
 	"emmcboot=echo Booting from the eMMC ...; " \
 		"bbdetect; " \
@@ -242,7 +244,7 @@
 		"load mmc 1:1 ${loadaddr} /boot/ts4900-fpga.bin; " \
 		"ice40 ${loadaddr} ${filesize}; " \
 		"load mmc 1:1 ${loadaddr} ${uimage}; " \
-		"setenv bootargs root=/dev/mmcblk2p1 rootwait rw ${cmdline_append}; " \
+		"setenv bootargs ${resin_kernel_root} rootwait rw console=ttymxc0,115200 enable_wait_mode=off; " \
 		"bootm ${loadaddr} - ${fdtaddr}; \0" \
 	"sataboot=echo Booting from SATA ...; " \
 		"bbdetect; " \
@@ -290,8 +292,16 @@
 
 #define CONFIG_BOOTCOMMAND \
 	"run usbprod; " \
+	"setenv resin_kernel_load_addr ${loadaddr}; "\
+	"run resin_set_kernel_root; "\
 	"if test ${jpsdboot} = 'on' ; " \
-		"then run sdboot; " \
+		"then " \
+			"if test -n \"${resin_flasher_dev_index}\" ; " \
+				"then run sdboot; " \
+				"else if test -n \"${resin_image_dev_index}\" ; " \
+					"then run emmcboot; " \
+				"fi;" \
+			"fi;" \
 		"else run emmcboot; " \
 	"fi;"
 
-- 
2.7.4

